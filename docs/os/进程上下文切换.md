# 进程上下文切换

## 系统调用
[[系统调用]] 称为 特权模式切换，但实际也发生了 [[CPU 上下文切换]]

## CPU 特权等级 
[[CPU 特权等级]]

## 内核态
进程的切换只能发生在 [[内核态]]

```
         ┌────────────────────────┐       ┌──────────────────────────┐
         │                        │       │                          │
         │      P1  Context       │       │        P2 Context        │
         │                        │       │                          │
         └────────────┬───────────┘       └────────────▲─────────────┘
                      │                                │
        ┌─────────────┼────────────────────────────────┼──────────────┐
        │             │                                │              │
        │      ┌──────▼────────────┐        ┌──────────┴─────────┐    │
        │      │                   │        │                    │    │
        │      │     P1 Kernal     │        │     P2 Kernal      │    │
        │      │                   ├────────►                    │    │
        │      │      Context      │        │      Context       │    │
        │      │                   │        │                    │    │
        │      └───────────────────┘        └────────────────────┘    │
        │                                                             │
        └─────────────────────────────────────────────────────────────┘
```

## 性能消耗
1. cpu 保存恢复 上下文
需要先把该进程的虚拟内存、栈等保存下来；
而加载了下一进程的内核态后，还需要刷新进程的虚拟内存和用户栈。

消耗：几十纳秒到数微秒的 CPU 时间。

2. TLB 缓存刷新 影响其他 CPU
多 CPU 共享缓存 

## 开销比较
进程上线文切换>
同进程线程上线文切换>
中断上线文切换>
内核模式切换>
协程上线文切换 or 用户态函数调用上下文切换

## 场景
- [[进程调度算法]]  被动
  - 时间片，内核控制，进程被动切出
  - 优先级进程
- [[硬件中断]] 挂起，转而执行内核中的 [[ISR]]

- 睡眠 主动挂起
- 系统资源不足 等待，如内存， 主动挂起等待
